<script src="/assets/js/sidebar-folder.js"></script>
<script src="/assets/js/clap-button.js"></script>
{% if site.lightbox %}
  <script src="/assets/js/lightbox.js"></script>
{% endif %}

<script>
  function show_utterances_fallback(container, message) {
    if (!container) {
      return;
    }

    if (container.querySelector(".utterances-fallback")) {
      return;
    }

    var fallback = document.createElement("p");
    fallback.className = "utterances-fallback";
    fallback.textContent = message;
    container.appendChild(fallback);
  }

  function load_utterances() {
    var container = document.getElementById("utterances-container");
    if (!container) {
      return;
    }

    var repo = container.dataset.utterancesRepo;
    if (!repo) {
      container.setAttribute("aria-busy", "false");
      show_utterances_fallback(container, "Comments are not configured.");
      return;
    }

    if (container.querySelector("iframe.utterances-frame") || container.querySelector("script[src*='utteranc.es']")) {
      return;
    }

    var script = document.createElement("script");
    script.src = "https://utteranc.es/client.js";
    script.async = true;
    script.setAttribute("repo", repo);
    script.setAttribute("issue-term", container.dataset.utterancesIssueTerm || "pathname");

    if (container.dataset.utterancesLabel) {
      script.setAttribute("label", container.dataset.utterancesLabel);
    }

    if (container.dataset.utterancesTheme) {
      script.setAttribute("theme", container.dataset.utterancesTheme);
    }

    script.setAttribute("crossorigin", "anonymous");
    script.onload = function () {
      container.setAttribute("aria-busy", "false");
    };
    script.onerror = function () {
      container.setAttribute("aria-busy", "false");
      show_utterances_fallback(container, "Failed to load comments.");
    };
    container.appendChild(script);
  }

  document
    .getElementById("_pushState")
    .addEventListener("hy-push-state-load", function () {
      if (typeof get_clap_count === "function") {
        get_clap_count();
      }

      if (typeof apply_lightbox === "function") {
        apply_lightbox();
      }
      load_utterances();
    });

  load_utterances();
</script>
